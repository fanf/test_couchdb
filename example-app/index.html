<!DOCTYPE html>
<html ng-app="CouchApp">
<head>
  <title>Community DB</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
</head>
<body style="padding-top: 10px">

<div class="container" ng-controller="ctrlPeople">
    <h2>AngularJS/CouchDB + CornerCouch Community DB</h2>
    
    <h3>Community DB entries <small>(click for detail)</small></h3>
    <table class="table table-striped">
        <thead>
        <tr><th>First Name</th><th>Last Name</th><th>Twitter</th></tr>
        </thead>
        <tbody>
        <tr ng-repeat="row in peopledb.rows" ng-click="rowClick($index)">
            <td class="span2">{{ row.doc.personalInformation.firstName }}</td>
            <td class="span6">{{ row.doc.personalInformation.lastName }}</td>
            <td class="span2">{{ row.doc.twitter.screenName }}</td>
        </tr>
        </tbody>
    </table>
    <ul class="pager">
        <li><a ng-click="prevClick()" ng-show="peopledb.prevRows.length">&lt;&lt;&lt;</a></li>
        <li><a ng-click="nextClick()" ng-show="peopledb.nextRow">&gt;&gt;&gt;</a></li>
    </ul>
    <form name="formNewPeople" class="offset1 span9" ng-submit="submitEntry()">
    <button class="submit" ng-disabled="formNewPeople.$invalid">New people</button>
    </form>
    <div class="alert alert-info" ng-show="detail._id">
        <div class="navbar" ng-show="detail._attachments">
        <div class="navbar-inner">
            <a class="brand">Attachments:</a>
            <ul class="nav" ng-repeat="(name,info) in detail._attachments">
                <li class="divider-vertical"></li>
                <li><a href="{{ detail.attachUri(name) }}" target="_blank"></i>{{ name }}</a></li>
                <li><i class="icon-remove" ng-click="detachClick(name)"></i></li>
            </ul>
        </div></div>
        <div class="btn btn-primary span2" style="float: right" ng-click="removeClick()">Remove</div>
        <h4>{{detail.personalInformation.firstName}} {{detail.personalInformation.lastName}}</h4>
        <p>_id = "{{detail._id}}", _rev ="{{detail._rev}}"</p>
        <form name="formDetail">
            <div class="btn btn-primary span2" style="float: right" ng-click="updateClick()" ng-show="formDetail.$dirty">Update</div>
            <h4>Personal Information</h4>
            <label>First Name</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.firstName">
            <label>Last Name</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.lastName">
            <label>Email</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.email">
            <label>Address</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.address">
            <label>City</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.city">
            <label>State</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.state">
            <label>Country</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.country">
            <label>Job Title</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.jobTitle">
            <label>Blog</label>
            <input name="details" type="text" class="span9" ng-model="detail.personalInformation.blog">
            <h4>Company</h4>
            <label>Name</label>
            <input name="details" type="text" class="span9" ng-model="detail.company.name">
            <label>Country</label>
            <input name="details" type="text" class="span9" ng-model="detail.company.country">
            <label>Address</label>
            <input name="details" type="text" class="span9" ng-model="detail.company.address">
            <label>Website</label>
            <input name="details" type="text" class="span9" ng-model="detail.company.website">
            <h4>Twitter</h4>
            <label>Screen name</label>
            <input name="details" type="text" class="span9" ng-model="detail.twitter.screenName">
            <h4>Add file attachment</h4>
            <input type="file" id="upload" class="span9">
            <div class="btn btn-primary span2" style="float: right" ng-click="attachClick()" ng-hide="formDetail.$dirty">Attach</div>
        </form>
    </div>
    <div class="alert alert-error" ng-show="errordata">{{ errordata | json }}</div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.5/angular.min.js"></script>
<script src="lib/angular-cornercouch.js"></script>
<script>
angular.module('CouchApp', ['CornerCouch']);

function ctrlPeople($scope, $filter, cornercouch) {
    
    $scope.server = cornercouch();
    $scope.server.session();
    $scope.peopledb = $scope.server.getDB('example');
    $scope.newentry = $scope.peopledb.newDoc();
    $scope.peopledb.query("example-app", "all_people", { include_docs: true, descending: true, limit: 8 });
        
    function setError(data, status) {
        $scope.errordata = { "status": status, "data": data };
    }

    $scope.rowClick = function(idx) {
        $scope.detail = $scope.peopledb.getQueryDoc(idx);
        //New feature in AngularJS 1.1+
        $scope.formDetail.$setPristine();
    };
    
    $scope.nextClick = function() { $scope.peopledb.queryNext(); delete $scope.detail; };
    $scope.prevClick = function() { $scope.peopledb.queryPrev(); delete $scope.detail; };
    
    $scope.removeClick = function() {
        $scope.detail.remove()
            .success(function() {
                delete $scope.detail;
                $scope.peopledb.queryRefresh();
            });
    };

    $scope.updateClick = function() {
        $scope.detail.save()
            .error(setError)
            .success( function () {
                //New feature in AngularJS 1.1+
                $scope.formDetail.$setPristine();
            });
    };
    
    $scope.attachClick = function() {

        var fileInput = document.getElementById("upload");
        if (fileInput.files.length === 0) return;
        
        $scope.detail.attach(fileInput.files[0])
            .error(setError)
            .success( function () {
                fileInput.value = "";
            });
    };

    $scope.detachClick = function(name) {
            $scope.detail.detach(name);
    };

    $scope.submitEntry = function() {
        
        $scope.newentry.personalInformation.firstName = "<new people>";
        
        $scope.newentry.save().success( function() {
            delete $scope.errordata;
            $scope.detail = $scope.newentry;
            $scope.newentry = $scope.peopledb.newDoc();
            $scope.peopledb.query("example-app", "all_people", { include_docs: true, descending: true, limit: 8 });
        });
    };
}
</script>
</body>
</html>
